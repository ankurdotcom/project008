<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Offline-First Grocery POS System">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.svg" sizes="any">
    <link rel="apple-touch-icon" href="/icon-192x192.svg">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' http://localhost:9090; object-src 'none'; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <!-- Cache Control Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Grocery POS System</title>
    <script src="lib/react.development.js"></script>
    <script src="lib/react-dom.development.js"></script>
    <script src="lib/babel.min.js"></script>
    <script src="indexeddb-manager.js?v=1.3"></script>

    <!-- CDN Fallback for external dependencies -->
    <script>
        // Fallback loader for incognito/private browsing mode
        window.addEventListener('load', function() {
            const loadFallback = (url, localPath, globalVar) => {
                return new Promise((resolve, reject) => {
                    if (window[globalVar]) {
                        resolve(); // Already loaded
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            };

            const checkDependencies = async () => {
                const errors = [];
                let loadedFromCDN = false;

                // Check if local files loaded
                if (typeof React === 'undefined') {
                    console.log('üîÑ React not loaded locally, trying CDN...');
                    try {
                        await loadFallback('https://unpkg.com/react@18/umd/react.development.js', 'lib/react.development.js', 'React');
                        loadedFromCDN = true;
                    } catch (e) {
                        errors.push('React');
                    }
                }

                if (typeof ReactDOM === 'undefined') {
                    console.log('üîÑ ReactDOM not loaded locally, trying CDN...');
                    try {
                        await loadFallback('https://unpkg.com/react-dom@18/umd/react-dom.development.js', 'lib/react-dom.development.js', 'ReactDOM');
                        loadedFromCDN = true;
                    } catch (e) {
                        errors.push('ReactDOM');
                    }
                }

                if (typeof Babel === 'undefined') {
                    console.log('üîÑ Babel not loaded locally, trying CDN...');
                    try {
                        await loadFallback('https://unpkg.com/@babel/standalone/babel.min.js', 'lib/babel.min.js', 'Babel');
                        loadedFromCDN = true;
                    } catch (e) {
                        errors.push('Babel');
                    }
                }

                if (errors.length > 0) {
                    console.warn('‚ö†Ô∏è External dependencies failed to load:', errors.join(', '));
                    console.warn('üîÑ Falling back to basic HTML/CSS/JS mode');

                    // Show fallback UI
                    showFallbackMode(errors);
                } else {
                    if (loadedFromCDN) {
                        console.log('‚úÖ Dependencies loaded from CDN fallback');
                    } else {
                        console.log('‚úÖ All dependencies loaded from local files');
                    }

                    // Re-render the app if it was waiting for dependencies
                    if (window.pendingRender) {
                        window.pendingRender();
                    }
                }
            };

            // Small delay to ensure local scripts have time to load/fail
            setTimeout(checkDependencies, 500);
        });

        function showFallbackMode(missingDeps) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="text-align: center; padding: 2rem; font-family: Arial, sans-serif; background: #f5f5f5; min-height: 100vh;">
                        <h1 style="color: #2196F3;">üõí Grocery POS System</h1>
                        <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 2rem auto;">
                            <h2 style="color: #f44336;">‚ö†Ô∏è Limited Mode</h2>
                            <p>External dependencies failed to load: <strong>${missingDeps.join(', ')}</strong></p>
                            <p>The POS system is running in basic mode with limited features.</p>
                            <p style="color: #666; font-size: 0.9rem; margin-top: 1rem;">
                                <strong>Available Features:</strong><br>
                                ‚Ä¢ Basic HTML interface<br>
                                ‚Ä¢ Offline data storage<br>
                                ‚Ä¢ Service worker caching<br>
                                ‚Ä¢ Manual data sync
                            </p>
                            <button onclick="window.location.reload()" style="padding: 0.75rem 1.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                üîÑ Retry Loading
                            </button>
                        </div>
                    </div>
                `;
            }
        }
    </script>
    <script>
        // Service Worker and Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    console.log('üîß Registering Service Worker...');
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });

                    console.log('‚úÖ Service Worker registered successfully:', registration.scope);

                    // Handle service worker updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('A new version of the POS system is available. Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        }
                    });

                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        console.log('üì® Message from Service Worker:', event.data);

                        switch (event.data.type) {
                            case 'SALE_QUEUED_OFFLINE':
                                // Show notification that sale is queued
                                showNotification('Sale Queued', 'Your sale has been queued and will sync when online.', 'info');
                                break;
                            case 'SYNC_PENDING_SALES':
                                // Trigger sync of pending sales
                                syncPendingData();
                                break;
                            case 'SYNC_SALES_STATS':
                                // Trigger sync of sales stats
                                syncSalesStats();
                                break;
                        }
                    });

                    // Register background sync if supported
                    if ('sync' in registration) {
                        try {
                            await registration.sync.register('sync-pending-sales');
                            console.log('‚úÖ Background sync registered for pending sales');
                        } catch (error) {
                            console.log('‚ö†Ô∏è Background sync registration failed:', error);
                        }
                    }

                } catch (error) {
                    console.error('‚ùå Service Worker registration failed:', error);
                }
            });
        } else {
            console.warn('‚ö†Ô∏è Service Workers not supported in this browser');
        }

        // Offline/Online status handling
        let isOnline = navigator.onLine;
        let syncInProgress = false;

        function updateOnlineStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;

            if (wasOnline !== isOnline) {
                console.log(`üåê Connection status changed: ${isOnline ? 'ONLINE' : 'OFFLINE'}`);

                // Dispatch custom event for React components
                window.dispatchEvent(new CustomEvent('connectionchange', {
                    detail: { online: isOnline }
                }));

                if (isOnline) {
                    showNotification('Back Online', 'Connection restored. Syncing data...', 'success');
                    // Trigger sync when coming back online
                    setTimeout(() => {
                        syncPendingData();
                        syncSalesStats();
                    }, 1000);
                } else {
                    showNotification('Offline Mode', 'You are now offline. Data will be stored locally.', 'warning');
                }
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Periodic connectivity check
        setInterval(() => {
            if (!navigator.onLine && !syncInProgress) {
                // Try to ping server to check if connection is actually available
                fetch('/favicon.ico', { method: 'HEAD', cache: 'no-cache' })
                    .then(() => {
                        if (!isOnline) {
                            console.log('üåê Connection detected via ping');
                            updateOnlineStatus();
                        }
                    })
                    .catch(() => {
                        // Still offline
                    });
            }
        }, 30000); // Check every 30 seconds

        // Sync pending data
        async function syncPendingData() {
            if (syncInProgress || !isOnline) return;

            syncInProgress = true;
            console.log('üîÑ Starting data sync...');

            try {
                // Get all pending messages from IndexedDB
                if (window.indexedDBManager) {
                    const pendingMessages = await window.indexedDBManager.getAllSales();

                    if (pendingMessages && pendingMessages.length > 0) {
                        console.log(`üì§ Syncing ${pendingMessages.length} pending sales...`);

                        let syncedCount = 0;
                        for (const message of pendingMessages) {
                            if (message.state !== 'SYNCED') {
                                try {
                                    const response = await fetch('/api/sales', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify(message.data)
                                    });

                                    if (response.ok) {
                                        await window.indexedDBManager.updateMessageState(message.id, 'SYNCED');
                                        syncedCount++;
                                    }
                                } catch (error) {
                                    console.warn(`‚ö†Ô∏è Failed to sync message ${message.id}:`, error);
                                }
                            }
                        }

                        if (syncedCount > 0) {
                            showNotification('Sync Complete', `${syncedCount} sales synced successfully!`, 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
            } finally {
                syncInProgress = false;
            }
        }

        // Sync sales statistics
        async function syncSalesStats() {
            if (!isOnline) return;

            try {
                console.log('üîÑ Syncing sales statistics...');
                // This will be handled by the React component's fetchSalesStats function
                window.dispatchEvent(new CustomEvent('syncstats'));
            } catch (error) {
                console.error('‚ùå Stats sync failed:', error);
            }
        }

        // Notification system
        function showNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <strong>${title}</strong><br>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
                color: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                font-family: Arial, sans-serif;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Add notification styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .notification-close {
                position: absolute;
                top: 5px;
                right: 10px;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                opacity: 0.8;
            }
            .notification-close:hover {
                opacity: 1;
            }
        `;
        document.head.appendChild(style);

        console.log('üéØ Offline support initialized');
    </script>
    <!-- <script src="indexeddb-tests.js"></script> -->
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2196F3; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .item-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .item-card:hover { transform: translateY(-2px); }
        .cart { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .btn { background: #4CAF50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #45a049; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        .total { font-size: 1.2rem; font-weight: bold; margin-top: 1rem; }
        .payment { background: white; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .role-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .owner-theme { border-left: 4px solid #2196F3; }
        .sales-theme { border-left: 4px solid #4CAF50; }
    </style>
</head>
<body>
    <div id="root">
        <!-- Fallback UI in case React fails to load -->
        <div style="text-align: center; padding: 2rem; font-family: Arial, sans-serif;">
            <h1 style="color: #2196F3;">üõí Grocery POS System</h1>
            <p>Loading application...</p>
            <div style="margin: 2rem 0;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <p style="color: #666; font-size: 0.9rem;">If this message persists, please check the browser console for errors.</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sample grocery items
        const GROCERY_ITEMS = [
            { id: '1', name: 'Apple', price: 2.50, category: 'Fruits', unit: 'kg' },
            { id: '2', name: 'Bread', price: 3.00, category: 'Bakery', unit: 'loaf' },
            { id: '3', name: 'Milk', price: 4.50, category: 'Dairy', unit: 'liter' },
            { id: '4', name: 'Banana', price: 1.20, category: 'Fruits', unit: 'kg' },
            { id: '5', name: 'Cheese', price: 5.00, category: 'Dairy', unit: 'kg' },
            { id: '6', name: 'Orange', price: 3.50, category: 'Fruits', unit: 'kg' },
            { id: '7', name: 'Yogurt', price: 2.00, category: 'Dairy', unit: 'cup' },
            { id: '8', name: 'Croissant', price: 1.50, category: 'Bakery', unit: 'piece' }
        ];

        function GroceryPOS() {
            console.log('üõí Grocery POS Component Loading...');
            
            const [cart, setCart] = useState([]);
            const [cashAmount, setCashAmount] = useState('');
            const [showPayment, setShowPayment] = useState(false);
            const [salesStats, setSalesStats] = useState(null);
            const [showSalesDashboard, setShowSalesDashboard] = useState(false);
            const [userRole, setUserRole] = useState(null);
            const [userEmail, setUserEmail] = useState('');
            const [showLogin, setShowLogin] = useState(true);
            const [showUserManagement, setShowUserManagement] = useState(false);
            const [users, setUsers] = useState([
                { email: 'owner@grocery.com', role: 'owner', isInitial: true }
            ]);
            const [newUserEmail, setNewUserEmail] = useState('');
            const [newUserRole, setNewUserRole] = useState('sales');
            const [securityErrors, setSecurityErrors] = useState([]);
            const [hasError, setHasError] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbInitialized, setDbInitialized] = useState(false);

            console.log('‚úÖ React State Initialized');

            // Initialize IndexedDB on component mount
            React.useEffect(() => {
                const initDB = async () => {
                    try {
                        if (window.indexedDB) {
                            await window.indexedDBManager.init();
                            setDbInitialized(true);
                            console.log('‚úÖ IndexedDB initialized successfully');
                        } else {
                            console.error('‚ùå IndexedDB not supported');
                            setErrorMessage('IndexedDB is not supported in this browser');
                            setHasError(true);
                        }
                    } catch (error) {
                        console.error('‚ùå IndexedDB initialization failed:', error);
                        setErrorMessage('Failed to initialize local storage');
                        setHasError(true);
                    }
                };

                initDB();
            }, []);

            // Monitor online/offline status
            React.useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    console.log('üåê Online - attempting to sync queued data');
                    // Trigger sync when coming back online
                    setTimeout(() => {
                        syncPendingData();
                        fetchSalesStats();
                    }, 1000);
                };

                const handleOffline = () => {
                    setIsOnline(false);
                    console.log('üì¥ Offline - data will be stored locally');
                };

                // Listen for connection changes from service worker
                const handleConnectionChange = (event) => {
                    setIsOnline(event.detail.online);
                };

                // Listen for sync requests from service worker
                const handleSyncStats = () => {
                    fetchSalesStats();
                };

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                window.addEventListener('connectionchange', handleConnectionChange);
                window.addEventListener('syncstats', handleSyncStats);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    window.removeEventListener('connectionchange', handleConnectionChange);
                    window.removeEventListener('syncstats', handleSyncStats);
                };
            }, []);

            // Security: Log security events (defined first to avoid reference errors)
            const logSecurityEvent = (event, details) => {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    event: event,
                    details: details,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                console.log('SECURITY_EVENT:', JSON.stringify(logEntry));
                // In production, this would be sent to a secure logging service
            };

            // Security: Input validation and sanitization
            const validateEmail = (email) => {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailRegex.test(email) && email.length <= 254 && email.length >= 5;
            };

            const sanitizeInput = (input) => {
                if (typeof input !== 'string') return '';
                return input.replace(/[<>]/g, '').trim();
            };

            const validateNumeric = (value, min = 0, max = 999999) => {
                const num = parseFloat(value);
                return !isNaN(num) && num >= min && num <= max && isFinite(num);
            };

            // Security: Mask sensitive data
            const maskEmail = (email) => {
                if (!email || !email.includes('@')) return 'user@domain.com';
                const [local, domain] = email.split('@');
                const maskedLocal = local.charAt(0) + '*'.repeat(Math.max(0, local.length - 2)) + local.charAt(local.length - 1);
                return `${maskedLocal}@${domain}`;
            };

            // Error handling
            React.useEffect(() => {
                const handleError = (error) => {
                    console.error('Application Error:', error);
                    setHasError(true);
                    setErrorMessage(error.message || 'An unexpected error occurred');
                };

                window.addEventListener('error', handleError);
                window.addEventListener('unhandledrejection', (event) => {
                    handleError(event.reason);
                });

                return () => {
                    window.removeEventListener('error', handleError);
                    window.removeEventListener('unhandledrejection', handleError);
                };
            }, []);

            // If there's an error, show error UI
            if (hasError) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üõí Grocery POS System</h1>
                            <p style={{color: '#f44336'}}>Application Error</p>
                        </div>
                        <div style={{
                            background: '#ffebee',
                            color: '#c62828',
                            padding: '2rem',
                            borderRadius: '8px',
                            border: '1px solid #ffcdd2',
                            textAlign: 'center'
                        }}>
                            <h2>‚ö†Ô∏è Something went wrong</h2>
                            <p><strong>Error:</strong> {errorMessage}</p>
                            <p style={{fontSize: '0.9rem', marginTop: '1rem'}}>
                                Please check the browser console for more details and try refreshing the page.
                            </p>
                            <button
                                className="btn"
                                onClick={() => window.location.reload()}
                                style={{marginTop: '1rem'}}
                            >
                                üîÑ Reload Application
                            </button>
                        </div>
                    </div>
                );
            }

            const addToCart = (item) => {
                setCart(prevCart => {
                    const existingItem = prevCart.find(cartItem => cartItem.id === item.id);
                    if (existingItem) {
                        return prevCart.map(cartItem =>
                            cartItem.id === item.id
                                ? { ...cartItem, quantity: cartItem.quantity + 1 }
                                : cartItem
                        );
                    }
                    return [...prevCart, { ...item, quantity: 1 }];
                });
            };

            const removeFromCart = (itemId) => {
                setCart(prevCart => prevCart.filter(item => item.id !== itemId));
            };

            const updateQuantity = (itemId, newQuantity) => {
                if (newQuantity <= 0) {
                    removeFromCart(itemId);
                    return;
                }
                setCart(prevCart =>
                    prevCart.map(item =>
                        item.id === itemId ? { ...item, quantity: newQuantity } : item
                    )
                );
            };

            const getTotal = () => {
                return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            };

            const clearCart = () => {
                setCart([]);
                setCashAmount('');
                setShowPayment(false);
                console.log('üóëÔ∏è Cart cleared');
            };

            const processPayment = async () => {
                if (!dbInitialized) {
                    alert('Local storage not ready. Please wait for initialization.');
                    return;
                }

                const total = getTotal();
                const cash = parseFloat(cashAmount);

                // Security: Validate numeric input
                if (!validateNumeric(cashAmount, 0.01, 999999)) {
                    alert('Invalid cash amount entered');
                    logSecurityEvent('INVALID_PAYMENT_AMOUNT', { amount: cashAmount, user: maskEmail(userEmail) });
                    return;
                }

                if (cash < total) {
                    alert('Insufficient cash amount!');
                    logSecurityEvent('INSUFFICIENT_PAYMENT', { cash: cash, total: total, user: maskEmail(userEmail) });
                    return;
                }

                const change = cash - total;

                // Security: Validate change calculation
                if (change < 0 || !isFinite(change)) {
                    alert('Payment calculation error');
                    logSecurityEvent('PAYMENT_CALCULATION_ERROR', { cash: cash, total: total, change: change, user: maskEmail(userEmail) });
                    return;
                }

                // Prepare sales data for IndexedDB storage
                const salesData = {
                    items: cart.map(item => ({
                        id: item.id,
                        name: sanitizeInput(item.name),
                        price: item.price,
                        quantity: item.quantity,
                        total: item.price * item.quantity
                    })),
                    subtotal: total,
                    total: total,
                    cashAmount: cash,
                    change: change,
                    paymentMethod: 'cash',
                    timestamp: new Date().toISOString(),
                    processedBy: maskEmail(userEmail),
                    userRole: userRole,
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language
                    }
                };

                try {
                    // Store sales data in IndexedDB
                    const storedMessage = await window.indexedDBManager.storeSale(salesData);

                    // Also attempt to sync with server if online
                    if (isOnline) {
                        try {
                            const response = await fetch('/api/sales', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify(salesData)
                            });

                            if (response.ok) {
                                // Mark message as synced
                                await window.indexedDBManager.updateMessageState(storedMessage.id, 'SYNCED');
                                console.log('‚úÖ Sale synced with server');
                            } else {
                                console.warn('‚ö†Ô∏è Server sync failed, data stored locally');
                            }
                        } catch (syncError) {
                            console.warn('‚ö†Ô∏è Server sync failed, data stored locally:', syncError);
                        }
                    }

                    alert(`Payment successful!\nTotal: $${total.toFixed(2)}\nCash: $${cash.toFixed(2)}\nChange: $${change.toFixed(2)}\n\n--- RECEIPT ---\n${cart.map(item => `${sanitizeInput(item.name)} x${item.quantity} = $${(item.price * item.quantity).toFixed(2)}`).join('\n')}\n\nThank you for shopping!\n\n${isOnline ? '‚úÖ Sales data saved and synced!' : 'üíæ Sales data saved locally (will sync when online)'}`);
                    logSecurityEvent('PAYMENT_SUCCESSFUL', { total: total, cash: cash, change: change, user: maskEmail(userEmail), storedLocally: true });

                } catch (error) {
                    console.error('‚ùå Error storing sales data:', error);
                    alert(`Payment successful!\nTotal: $${total.toFixed(2)}\nCash: $${cash.toFixed(2)}\nChange: $${change.toFixed(2)}\n\n--- RECEIPT ---\n${cart.map(item => `${sanitizeInput(item.name)} x${item.quantity} = $${(item.price * item.quantity).toFixed(2)}`).join('\n')}\n\nThank you for shopping!\n\n‚ö†Ô∏è Warning: Sales data could not be saved locally. Please check storage permissions.`);
                    logSecurityEvent('PAYMENT_SAVE_ERROR', { error: error.message, user: maskEmail(userEmail) });
                }

                // Clear cart and reset
                setCart([]);
                setCashAmount('');
                setShowPayment(false);
            };

            const syncPendingData = async () => {
                if (!dbInitialized || !isOnline) return;

                try {
                    console.log('üîÑ Syncing pending sales data...');
                    const pendingMessages = await window.indexedDBManager.getAllSales();
                    let syncedCount = 0;

                    if (pendingMessages && pendingMessages.length > 0) {
                        for (const message of pendingMessages) {
                            if (message.state !== 'SYNCED') {
                                try {
                                    const response = await fetch('/api/sales', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify(message.data)
                                    });

                                    if (response.ok) {
                                        await window.indexedDBManager.updateMessageState(message.id, 'SYNCED');
                                        syncedCount++;
                                        console.log(`‚úÖ Synced sale ${message.id}`);
                                    }
                                } catch (error) {
                                    console.warn(`‚ö†Ô∏è Failed to sync sale ${message.id}:`, error);
                                }
                            }
                        }

                        if (syncedCount > 0) {
                            alert(`‚úÖ Successfully synced ${syncedCount} pending sales!`);
                            // Refresh sales stats after sync
                            fetchSalesStats();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error syncing pending data:', error);
                }
            };

            const fetchSalesStats = async () => {
                if (!dbInitialized) {
                    console.warn('IndexedDB not initialized, cannot fetch stats');
                    return;
                }

                try {
                    // Get sales statistics from IndexedDB
                    const stats = await window.indexedDBManager.getSalesStats();
                    setSalesStats(stats);

                    // Also attempt to sync with server if online
                    if (isOnline) {
                        try {
                            const response = await fetch('/api/sales/stats');
                            if (response.ok) {
                                const serverStats = await response.json();
                                // Merge server stats with local stats (server takes precedence for some metrics)
                                setSalesStats({
                                    ...stats,
                                    ...serverStats,
                                    // Keep local calculations for items that server might not have
                                    totalItemsSold: stats.totalItemsSold || serverStats.totalItemsSold
                                });
                            }
                        } catch (syncError) {
                            console.warn('Server stats sync failed, using local data only');
                        }
                    }

                    console.log('üìä Sales stats loaded:', stats);
                } catch (error) {
                    console.error('‚ùå Error fetching sales stats:', error);
                    // Set empty stats to prevent UI errors
                    setSalesStats({
                        totalSales: 0,
                        totalRevenue: 0,
                        averageSale: 0,
                        todaySales: 0,
                        todayRevenue: 0,
                        topItems: []
                    });
                }
            };

            const toggleSalesDashboard = () => {
                setShowSalesDashboard(!showSalesDashboard);
                if (!showSalesDashboard) {
                    fetchSalesStats();
                }
            };

            const toggleUserManagement = () => {
                setShowUserManagement(!showUserManagement);
            };

            const selectRole = (role) => {
                setUserRole(role);
                setShowRoleSelection(false);
            };

            const loginWithGmail = () => {
                if (!userEmail || !userEmail.includes('@')) {
                    alert('Please enter a valid Gmail address');
                    logSecurityEvent('INVALID_EMAIL_FORMAT', { email: maskEmail(userEmail) });
                    return;
                }

                // Security: Validate email format
                if (!validateEmail(userEmail)) {
                    alert('Invalid email format');
                    logSecurityEvent('INVALID_EMAIL_FORMAT', { email: maskEmail(userEmail) });
                    return;
                }

                // Security: Sanitize input
                const sanitizedEmail = sanitizeInput(userEmail);

                // Find user in the system
                const user = users.find(u => u.email.toLowerCase() === sanitizedEmail.toLowerCase());

                if (!user) {
                    alert('Gmail address not registered. Please contact the owner to add your account.');
                    logSecurityEvent('UNAUTHORIZED_ACCESS_ATTEMPT', { email: maskEmail(sanitizedEmail) });
                    return;
                }

                setUserRole(user.role);
                setShowLogin(false);
                alert(`Welcome ${user.role === 'owner' ? 'üëë Owner' : 'üõçÔ∏è Sales Person'}: ${maskEmail(user.email)}`);
                logSecurityEvent('SUCCESSFUL_LOGIN', { email: maskEmail(sanitizedEmail), role: user.role });
            };

            const addUser = () => {
                if (!newUserEmail || !newUserEmail.includes('@')) {
                    alert('Please enter a valid Gmail address');
                    logSecurityEvent('INVALID_EMAIL_FORMAT', { email: maskEmail(newUserEmail) });
                    return;
                }

                // Security: Validate email format
                if (!validateEmail(newUserEmail)) {
                    alert('Invalid email format');
                    logSecurityEvent('INVALID_EMAIL_FORMAT', { email: maskEmail(newUserEmail) });
                    return;
                }

                // Security: Sanitize input
                const sanitizedEmail = sanitizeInput(newUserEmail);

                if (users.some(u => u.email.toLowerCase() === sanitizedEmail.toLowerCase())) {
                    alert('This Gmail address is already registered');
                    logSecurityEvent('DUPLICATE_USER_ATTEMPT', { email: maskEmail(sanitizedEmail) });
                    return;
                }

                const newUser = {
                    email: sanitizedEmail,
                    role: newUserRole,
                    isInitial: false
                };

                setUsers([...users, newUser]);
                setNewUserEmail('');
                setNewUserRole('sales');
                alert(`User ${maskEmail(sanitizedEmail)} added as ${newUserRole === 'owner' ? 'Owner' : 'Sales Person'}`);
                logSecurityEvent('USER_ADDED', { email: maskEmail(sanitizedEmail), role: newUserRole, addedBy: maskEmail(userEmail) });
            };

            const removeUser = (email) => {
                if (email === 'owner@grocery.com') {
                    alert('Cannot remove the initial owner account');
                    return;
                }

                if (confirm(`Are you sure you want to remove ${email}?`)) {
                    setUsers(users.filter(u => u.email !== email));
                    alert(`User ${email} removed successfully`);
                }
            };

            const changeUserRole = (email, newRole) => {
                if (email === 'owner@grocery.com') {
                    alert('Cannot change the initial owner role');
                    return;
                }

                setUsers(users.map(u =>
                    u.email === email ? { ...u, role: newRole } : u
                ));
                alert(`${email} role changed to ${newRole === 'owner' ? 'Owner' : 'Sales Person'}`);
            };

            const logout = () => {
                setUserRole(null);
                setUserEmail('');
                setShowLogin(true);
                setCart([]);
                setCashAmount('');
                setShowPayment(false);
                setShowSalesDashboard(false);
                setShowUserManagement(false);
                setSalesStats(null);
                logSecurityEvent('USER_LOGOUT', { previousUser: maskEmail(userEmail), role: userRole });
            };

            // Login Screen
            if (showLogin) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üõí Grocery POS System</h1>
                            <p>Gmail Authentication Required</p>
                        </div>

                        <div style={{maxWidth: '400px', margin: '2rem auto'}}>
                            <div style={{
                                background: 'white',
                                padding: '2rem',
                                borderRadius: '12px',
                                boxShadow: '0 4px 8px rgba(0,0,0,0.1)'
                            }}>
                                <h2 style={{textAlign: 'center', marginBottom: '1.5rem', color: '#333'}}>
                                    üîê Login with Gmail
                                </h2>

                                <div style={{marginBottom: '1rem'}}>
                                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: 'bold'}}>
                                        Gmail Address:
                                    </label>
                                    <input
                                        type="email"
                                        className="input"
                                        placeholder="your.email@gmail.com"
                                        value={userEmail}
                                        onChange={(e) => setUserEmail(e.target.value)}
                                        style={{width: '100%', padding: '0.75rem', fontSize: '1rem'}}
                                    />
                                </div>

                                <button
                                    className="btn"
                                    onClick={loginWithGmail}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        fontSize: '1rem',
                                        background: '#4285f4',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        cursor: 'pointer'
                                    }}
                                >
                                    üìß Sign in with Gmail
                                </button>

                                <div style={{
                                    marginTop: '1rem',
                                    padding: '1rem',
                                    background: '#f8f9fa',
                                    borderRadius: '6px',
                                    fontSize: '0.9rem',
                                    color: '#666'
                                }}>
                                    <strong>Demo Accounts:</strong><br/>
                                    ‚Ä¢ Owner: owner@grocery.com<br/>
                                    ‚Ä¢ Sales: sales@grocery.com (if added by owner)
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`container ${userRole === 'owner' ? 'owner-theme' : 'sales-theme'}`}>
                    <div className="header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1>üõí Grocery POS System</h1>
                                <p>Professional Point of Sale for Grocery Store</p>
                                <div style={{
                                    fontSize: '0.9rem',
                                    color: '#e3f2fd',
                                    marginTop: '0.5rem',
                                    fontWeight: 'bold'
                                }}>
                                    Logged in as: {userRole === 'owner' ? 'üëë Owner' : 'üõçÔ∏è Sales Person'} ({maskEmail(userEmail)})
                                </div>
                            </div>
                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                {userRole === 'owner' && (
                                    <button
                                        className="btn"
                                        onClick={toggleUserManagement}
                                        style={{
                                            fontSize: '0.9rem',
                                            padding: '0.5rem 1rem',
                                            background: '#ff9800'
                                        }}
                                    >
                                        üë• {showUserManagement ? 'Hide Users' : 'Manage Users'}
                                    </button>
                                )}
                                <button
                                    className="btn btn-danger"
                                    onClick={logout}
                                    style={{fontSize: '0.9rem', padding: '0.5rem 1rem'}}
                                >
                                    Logout
                                </button>
                            </div>
                        </div>

                        {/* Status Indicators */}
                        <div style={{
                            display: 'flex',
                            gap: '1rem',
                            marginTop: '1rem',
                            fontSize: '0.9rem',
                            alignItems: 'center'
                        }}>
                            <span style={{
                                padding: '0.25rem 0.5rem',
                                borderRadius: '12px',
                                background: isOnline ? '#e8f5e8' : '#ffebee',
                                color: isOnline ? '#2e7d32' : '#c62828',
                                border: `1px solid ${isOnline ? '#4caf50' : '#f44336'}`
                            }}>
                                {isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                            </span>
                            <span style={{
                                padding: '0.25rem 0.5rem',
                                borderRadius: '12px',
                                background: dbInitialized ? '#e3f2fd' : '#fff3e0',
                                color: dbInitialized ? '#1976d2' : '#f57c00',
                                border: `1px solid ${dbInitialized ? '#2196f3' : '#ff9800'}`
                            }}>
                                {dbInitialized ? 'üíæ Storage Ready' : '‚è≥ Initializing...'}
                            </span>
                            {isOnline && dbInitialized && (
                                <button
                                    className="btn"
                                    onClick={syncPendingData}
                                    style={{
                                        fontSize: '0.8rem',
                                        padding: '0.25rem 0.75rem',
                                        background: '#ff9800',
                                        border: 'none',
                                        borderRadius: '12px',
                                        color: 'white',
                                        cursor: 'pointer'
                                    }}
                                    title="Sync pending data with server"
                                >
                                    üîÑ Sync Data
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="grid">
                        <div>
                            <h2>Available Items</h2>
                            <div className="items-grid">
                                {GROCERY_ITEMS.map(item => (
                                    <div key={item.id} className="item-card" onClick={() => addToCart(item)}>
                                        <h3>{item.name}</h3>
                                        <p>Category: {item.category}</p>
                                        <p><strong>${item.price.toFixed(2)} / {item.unit}</strong></p>
                                        <button className="btn">Add to Cart</button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div>
                            <div className="cart">
                                <h2>Shopping Cart ({cart.length} items)</h2>
                                {userRole === 'sales' && (
                                    <div style={{
                                        background: '#e8f5e8',
                                        color: '#2e7d32',
                                        padding: '0.5rem',
                                        borderRadius: '4px',
                                        marginBottom: '1rem',
                                        fontSize: '0.9rem',
                                        border: '1px solid #4caf50'
                                    }}>
                                        üí∞ <strong>Sales Mode:</strong> Process customer transactions and manage cart
                                    </div>
                                )}
                                {cart.length === 0 ? (
                                    <p>Cart is empty</p>
                                ) : (
                                    <>
                                        {cart.map(item => (
                                            <div key={item.id} className="cart-item">
                                                <div>
                                                    <strong>{item.name}</strong><br/>
                                                    ${item.price.toFixed(2)} / {item.unit}
                                                </div>
                                                <div>
                                                    <input 
                                                        type="number" 
                                                        value={item.quantity} 
                                                        onChange={(e) => updateQuantity(item.id, parseInt(e.target.value))}
                                                        style={{width: '60px', marginRight: '10px'}}
                                                        min="0"
                                                    />
                                                    <button 
                                                        className="btn btn-danger" 
                                                        onClick={() => removeFromCart(item.id)}
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        <div className="total">
                                            Total: ${getTotal().toFixed(2)}
                                        </div>

                                        <div style={{marginTop: '1rem'}}>
                                            <button 
                                                className="btn" 
                                                onClick={() => setShowPayment(!showPayment)}
                                                style={{marginRight: '10px'}}
                                            >
                                                {showPayment ? 'Hide Payment' : 'Proceed to Payment'}
                                            </button>
                                            <button className="btn btn-danger" onClick={clearCart}>
                                                Clear Cart
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>

                            {showPayment && cart.length > 0 && (
                                <div className="payment">
                                    <h3>Payment</h3>
                                    <p><strong>Total Amount: ${getTotal().toFixed(2)}</strong></p>
                                    <input 
                                        type="number" 
                                        className="input"
                                        placeholder="Enter cash amount"
                                        value={cashAmount}
                                        onChange={(e) => setCashAmount(e.target.value)}
                                        step="0.01"
                                        min="0"
                                    />
                                    {cashAmount && (
                                        <p>Change: ${Math.max(0, parseFloat(cashAmount) - getTotal()).toFixed(2)}</p>
                                    )}
                                    <button className="btn" onClick={processPayment}>
                                        Process Payment & Print Receipt
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div style={{marginTop: '2rem', textAlign: 'center'}}>
                        {userRole === 'owner' && (
                            <button className="btn" onClick={toggleSalesDashboard}>
                                {showSalesDashboard ? 'Hide Sales Dashboard' : 'Show Sales Dashboard'}
                            </button>
                        )}
                        {userRole === 'sales' && (
                            <div style={{
                                background: '#e8f5e8',
                                color: '#2e7d32',
                                padding: '1rem',
                                borderRadius: '8px',
                                border: '1px solid #4caf50'
                            }}>
                                <strong>üí° Sales Mode:</strong> Focus on customer service and transactions.
                                Dashboard access is restricted to owners only.
                            </div>
                        )}
                    </div>

                    {showSalesDashboard && userRole === 'owner' && (
                        <div className="sales-dashboard" style={{marginTop: '2rem'}}>
                            <h2>üìä Sales Dashboard</h2>
                            {salesStats ? (
                                <div className="stats-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                    <div className="stat-card" style={{border: '1px solid #ddd', padding: '1rem', borderRadius: '8px'}}>
                                        <h3>Total Sales</h3>
                                        <p style={{fontSize: '2rem', fontWeight: 'bold'}}>${salesStats.totalRevenue?.toFixed(2) || '0.00'}</p>
                                    </div>
                                    <div className="stat-card" style={{border: '1px solid #ddd', padding: '1rem', borderRadius: '8px'}}>
                                        <h3>Total Transactions</h3>
                                        <p style={{fontSize: '2rem', fontWeight: 'bold'}}>{salesStats.totalSales || 0}</p>
                                    </div>
                                    <div className="stat-card" style={{border: '1px solid #ddd', padding: '1rem', borderRadius: '8px'}}>
                                        <h3>Average Sale</h3>
                                        <p style={{fontSize: '2rem', fontWeight: 'bold'}}>${salesStats.averageSale?.toFixed(2) || '0.00'}</p>
                                    </div>
                                    <div className="stat-card" style={{border: '1px solid #ddd', padding: '1rem', borderRadius: '8px'}}>
                                        <h3>Items Sold</h3>
                                        <p style={{fontSize: '2rem', fontWeight: 'bold'}}>{salesStats.totalItemsSold || 0}</p>
                                    </div>
                                </div>
                            ) : (
                                <p>Loading sales statistics...</p>
                            )}
                        </div>
                    )}

                    {showUserManagement && userRole === 'owner' && (
                        <div className="user-management" style={{marginTop: '2rem'}}>
                            <h2>üë• User Management</h2>

                            {/* Add New User Section */}
                            <div style={{
                                background: 'white',
                                padding: '1.5rem',
                                borderRadius: '8px',
                                marginBottom: '2rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                            }}>
                                <h3>Add New User</h3>
                                <div style={{display: 'flex', gap: '1rem', alignItems: 'center', marginTop: '1rem'}}>
                                    <input
                                        type="email"
                                        placeholder="user@gmail.com"
                                        value={newUserEmail}
                                        onChange={(e) => setNewUserEmail(e.target.value)}
                                        style={{flex: 1, padding: '0.5rem'}}
                                    />
                                    <select
                                        value={newUserRole}
                                        onChange={(e) => setNewUserRole(e.target.value)}
                                        style={{padding: '0.5rem'}}
                                    >
                                        <option value="sales">Sales Person</option>
                                        <option value="owner">Owner</option>
                                    </select>
                                    <button className="btn" onClick={addUser}>
                                        Add User
                                    </button>
                                </div>
                            </div>

                            {/* User List Section */}
                            <div style={{
                                background: 'white',
                                padding: '1.5rem',
                                borderRadius: '8px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                            }}>
                                <h3>Registered Users ({users.length})</h3>
                                <div style={{marginTop: '1rem'}}>
                                    {users.map(user => (
                                        <div key={user.email} style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '1rem',
                                            border: '1px solid #eee',
                                            borderRadius: '6px',
                                            marginBottom: '0.5rem'
                                        }}>
                                            <div>
                                                <strong>{user.role === 'owner' ? 'üëë' : 'üõçÔ∏è'} {maskEmail(user.email)}</strong>
                                                <span style={{
                                                    marginLeft: '1rem',
                                                    padding: '0.2rem 0.5rem',
                                                    borderRadius: '12px',
                                                    fontSize: '0.8rem',
                                                    background: user.role === 'owner' ? '#e3f2fd' : '#e8f5e8',
                                                    color: user.role === 'owner' ? '#1976d2' : '#2e7d32'
                                                }}>
                                                    {user.role.toUpperCase()}
                                                </span>
                                                {user.isInitial && (
                                                    <span style={{
                                                        marginLeft: '0.5rem',
                                                        padding: '0.2rem 0.5rem',
                                                        borderRadius: '12px',
                                                        fontSize: '0.8rem',
                                                        background: '#fff3e0',
                                                        color: '#f57c00'
                                                    }}>
                                                        INITIAL OWNER
                                                    </span>
                                                )}
                                            </div>
                                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                                {!user.isInitial && (
                                                    <>
                                                        <select
                                                            value={user.role}
                                                            onChange={(e) => changeUserRole(user.email, e.target.value)}
                                                            style={{padding: '0.3rem', fontSize: '0.8rem'}}
                                                        >
                                                            <option value="sales">Sales</option>
                                                            <option value="owner">Owner</option>
                                                        </select>
                                                        <button
                                                            className="btn btn-danger"
                                                            onClick={() => removeUser(user.email)}
                                                            style={{fontSize: '0.8rem', padding: '0.3rem 0.6rem'}}
                                                        >
                                                            Remove
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Test if React is loaded and render the component
        console.log('üîß Testing React availability...');

        function renderApp() {
            if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
                console.log('‚úÖ React and ReactDOM are available');
                try {
                    // Use createRoot for React 18+ compatibility
                    const rootElement = document.getElementById('root');
                    if (ReactDOM.createRoot) {
                        const root = ReactDOM.createRoot(rootElement);
                        root.render(<GroceryPOS />);
                    } else {
                        // Fallback for older React versions
                        ReactDOM.render(<GroceryPOS />, rootElement);
                    }
                    console.log('‚úÖ Application rendered successfully');
                } catch (error) {
                    console.error('‚ùå Error rendering application:', error);
                    document.getElementById('root').innerHTML = `
                        <div style="text-align: center; padding: 2rem; font-family: Arial, sans-serif; color: #f44336;">
                            <h1>‚ùå Application Failed to Load</h1>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p>Please check the browser console for more details.</p>
                            <button onclick="window.location.reload()" style="padding: 0.5rem 1rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Reload</button>
                        </div>
                    `;
                }
            } else {
                console.error('‚ùå React or ReactDOM not available');
                document.getElementById('root').innerHTML = `
                    <div style="text-align: center; padding: 2rem; font-family: Arial, sans-serif; color: #f44336;">
                        <h1>‚ùå React Not Loaded</h1>
                        <p>React libraries failed to load. Please check your internet connection and try again.</p>
                        <button onclick="window.location.reload()" style="padding: 0.5rem 1rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Reload</button>
                    </div>
                `;
            }
        }

        // Try to render immediately, or store for later if dependencies aren't ready
        if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
            renderApp();
        } else {
            // Store render function for when dependencies load
            window.pendingRender = renderApp;
            console.log('‚è≥ Waiting for dependencies to load...');
        }
    </script>
</body>
</html>
